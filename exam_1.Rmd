---
title: "Exam 1"
author: "Westley Cook"
date: "2/22/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Loading the three packages I know I'll need to use at various points;
# tidyverse for its dplyr and ggplot2 packages, janitor to clean names after
# reading in data, and gt to make a table on question three

library(tidyverse)
library(janitor)
library(gt)

```

```{r read-paris-data, include=FALSE}

# Reading in paris data (after making the "raw-data" subdirectory and moving the
# .csv file there) and running clean_names() just to be safe

paris <- read_csv("raw-data/paris.csv") %>% 
  clean_names()

```

### Question 1

```{r question1.1, echo=FALSE}

# This r chunk assigns two objects to place in-line for mad lib 1.

# Arranging the paris data in descending order of emissions, slicing the first
# row and pulling the name column to get the country name.

in_country <- paris %>% 
  arrange(desc(emissions)) %>% 
  slice(1) %>% 
  pull(name)

# I realized after doing the above that the sentence "the highest emissions are
# from [country]" would be more meaningful with a bit more context (without
# context, one might misunderstand the sentence to mean something like "the
# highest *average* emissions) so I ran the same code but pulled the year column
# this time and added it to the end of the mad lib to clarify that the highest
# single-year emissions in the data set came from China in 2005.

in_year <- paris %>% 
  arrange(desc(emissions)) %>% 
  slice(1) %>% 
  pull(year)

```

1. The highest emissions are from the country **`r in_country`** in
**`r in_year`**.

```{r question1.2, echo=FALSE}

# This r chunk assigns an object to place in-line for mad lib 2.

# Filtering paris once to take out the ratifying countries, then again to take
# out the approving countries. The resulting data was small enough that I could
# look through the 9 rows to see that all of the countries left had indicated
# either acceptance or accession, and that the only NA values left were in the
# signature column for the two countries indicating accession. I figured that
# the signature probably wasn't required for countries indicating accession, and
# thus left those two countries in the total count.

number_countries <- paris %>% 
  filter(kind != "Ratification") %>% 
  filter(kind != "Approval") %>% 
  count() %>% 
  pull(n)

# I also added an explanatory note in italics which will show up on the finished
# .html file, saying what it means for a country in this dataset to have neither
# ratified nor approved the treaty.

```

2. The number of countries that have neither ratified nor approved of the treaty
is **`r number_countries`**.
*This number includes only countries who indicated acceptance or accession.*

```{r question1.3, echo=FALSE}

# This r chunk assigns an object to place in-line for mad lib 3.

# This one tripped me up for a little bit, because I'd originally used
# read.csv() instead of read_csv() to read in the paris data, and it made the
# ratification and signature columns factors instead of dates. I had a hard time
# converting them into the file type I wanted, but eventually figured out via
# google that read_csv() wouldn't create that problem for me. Once I got the
# columns to be the appropriate type, the rest was easy.

# Filtering for just the ratifying countries, then creating a new variable
# ("gap") to show the number of days between signature and ratification for each
# ratifying country (couldn't do this with these variables when they were
# factors, but can do it easily with dates; data type matters!). Arranging the
# data in descending "gap" order to find the highest value, then slicing the
# first row and pulling gap.

longest_days <- paris %>% 
  filter(kind == "Ratification") %>% 
  mutate(gap = ratification - signature) %>% 
  arrange(desc(gap)) %>% 
  slice(1) %>% 
  pull(gap)
  
```

3. The longest number of days between signature and ratification (for a country
that has successfully ratified) is **`r longest_days`** days.

```{r question1.4, echo=FALSE}

# This r chunk assigns an object to place in-line for mad lib 4.

# Filtering the paris data for countries whose name contains "stan" (because I
# didn't know how to limit the str_detect() function to just those countries
# whose names END with "stan"). But the result of that filter was just seven
# rows, so I looked at all of them and manually checked that they all ended in
# "stan" (rather than have a "stan" somewhere in their name). At that point it
# was easy to pipe the filter to a count() function to tell me the number of
# rows, and pull the number of rows.

number_stan <- paris %>% 
  filter(str_detect(name, "stan"),
         kind == "Ratification") %>% 
  count() %>% 
  pull(n)

```

4. The number of ratifying countries whose name ends with “stan” is 
**`r number_stan`**.

```{r read-co2-data, include=FALSE}

# This r chunk reads in the WB co2 emissions data.

# In order to figure out how many lines to skip to get the first rows of actual
# data (which had column names) at the top, I first read in the data without
# skipping any lines and used glimpse() and head() to see in what row the column
# names were located; I then added skip = 4 to the read_csv() function to cut
# out the unnecessary rows. I also used tail() to make sure there weren't rows
# at the bottom which I wouldn't need.

# I added the col_types = cols() argument later, in order to make the message
# "Parsed with..." go away in the output (this maybe wasn't necessary, since I'm
# using include=FALSE in the r chunk, but I thought it was good practice).

# Used clean_names() to fix the numeric column names.

emissions <- read_csv("raw-data/WB_co2_emisions.csv", 
                      skip = 4,
                      col_types = cols()) %>% 
  clean_names()

```

```{r question1.5, echo=FALSE}

# 

highest_1960 <- emissions %>% 
  arrange(desc(x1960)) %>% 
  slice(1) %>% 
  pull(country_name)

```

5. In 1960, the country with the highest emissions was **`r highest_1960`**.

```{r question1.6, echo=FALSE}

avg2000 <- emissions %>% 
  summarize(avg_2000 = mean(x2000, na.rm = TRUE)) %>% 
  pull(avg_2000) %>% 
  round(digits = 2)

```
  
6. The average emissions in 2000 was **`r avg2000`** metric tons per capita.

<br>

### Question 2

```{r question2, echo=FALSE}

emissions_tidy <- emissions %>% 
pivot_longer(cols = c(x1960:x2019),
             names_to = "year",
             values_to = "emissions_per_captita",
             names_prefix = "x") %>% 
  type_convert(col_types = cols())
  

joined <- emissions_tidy %>% 
  left_join(paris,
             by = c("year", 
                    "country_code" = "code"))

# x %>% 
#   filter(year == "1960") %>% 
#   arrange(emissions_per_captita)
# 
# x %>% 
#   filter(year == "1960") %>% 
#   arrange(desc(emissions_per_captita))

date <- joined %>%
  filter(date_of_effect == "2016-11-04") %>%
  slice(1) %>%
  pull(date_of_effect)

joined %>% 
  filter(country_name == "United States" |
           country_name == "Canada" |
           country_name == "Mexico",
         emissions_per_captita != "NA") %>% 
  ggplot(aes(x = year,
             y = emissions_per_captita,
             color = country_name,
             group = country_name)) +
  geom_point() +
  geom_line() +
  geom_vline(xintercept = as.numeric(format(date, "%Y")),
             linetype = "dotted") +
  labs(title = "   CO2 Emissions of North American Countries, 1960 - 2014",
       y = "Metric Tons Per Capita",
       x = "Year") +
  scale_color_discrete(name = "Country",
                       breaks = c("United States",
                                  "Canada",
                                  "Mexico")) +
  scale_x_continuous(breaks = seq(1960,
                                  2020,
                                  by = 10),
                     labels = c("1960",
                                "1970",
                                "1980",
                                "1990",
                                "2000",
                                "2010",
                                "2020")
                     ) +
  theme_classic() +
  annotate("text",
           x = 2016, 
           y = 9.5, 
           label = "Year Paris Accord\nTook Effect (2016)",
           color = "gray28",
           size =3.5,
           angle = 90)

```

<br>

### Question 3

#### Potential Outcomes under the Rubin Causal Framework

The table below shows potential outcomes under the Rubin Causal Framework for
countries which ratified the Paris Accord. Suppose we had run an experiment in
which we assigned a treatment to all countries whose name begins with a vowel:
we gave each of them $1 billion to fight climate change.

(Assigning treatment to countries whose name begins with a
vowel may not be a very good random assignment mechanism and may even compromise
the results of our experiment, since there are far more countries whose names
begin with consonants and ideally we’d have ~50% of countries receiving
treatment and the remaining ~50% in the control group; nevertheless, suppose we
used it.)

The causal effect we are trying to measure is the difference in emissions for a
given country when it receives $1 billion compared to emissions for the same
country when it does *not* receive $1 billion. Measuring this causal effect is
difficult, because we only know one value per country: as you see in the table
(in which unknown values are marked by “?”) emissions for a “treated” country
are unknown in the “Control” column and vice versa. However, by making
assumptions to “fill in” the unknown values, we can approximate the causal
effect.

<br>

```{r question3, echo=FALSE}

paris_experiment <- paris %>% 
  filter(kind == "Ratification") %>% 
  select(name, emissions) %>% 
  mutate(emissions_treatment = emissions) %>% 
  rename(emissions_control = emissions) %>% 
  mutate(emissions_treatment = ifelse(startsWith(name, "A") |
                                        startsWith(name, "E") |
                                        startsWith(name, "I") |
                                        startsWith(name, "O") |
                                        startsWith(name, "U"),
                                      emissions_treatment,
                                      "?")) %>% 
  mutate(emissions_control = ifelse(startsWith(name, "A") |
                                        startsWith(name, "E") |
                                        startsWith(name, "I") |
                                        startsWith(name, "O") |
                                        startsWith(name, "U"),
                                      "?",
                                      emissions_control))


paris_experiment %>%
  filter(name == "Afghanistan" |
           name == "Bahamas" |
           name == "Cabo Verde" |
           name == "Democratic People's Repulbic of Korea" |
           name == "Ecuador" |
           name == "Finland" |
           name == "Gabon" |
           name == "Haiti" |
           name == "India" |
           name == "Jamaica" |
           name == "Kazakhstan" |
           name == "Lao People's Democratic Republic" |
           name == "Madagascar" |
           name == "Namibia" |
           name == "Oman" |
           name == "Pakistan" |
           name == "Qatar" |
           name == "Republic of Korea" |
           name == "Samoa" |
           name == "Tajikistan" |
           name == "Uganda" |
           name == "Vanuatu" |
           name == "Zambia") %>% 
  gt() %>% 
  tab_header(title = "Potential Outcomes for Paris Experiment on Emissions",
             subtitle = "For Selected Countries") %>% 
  
# Adding spanner label for columns eval_under_control and eval_under_treatment  
  
  tab_spanner(label = "Potential Outcomes",
              columns = vars(emissions_control,
                             emissions_treatment)
              ) %>% 
  
  tab_footnote(footnote = "Only one country is shown for each letter of the 
               alphabet (the first one in alphabetical order)",
               locations = cells_column_labels("name")
               ) %>% 
  
  tab_footnote(footnote = "Treatment is receiving $1 billion to fight climate 
               change, and was given to all countries whose name begins with 
               a vowel",
               locations = cells_column_labels("emissions_treatment")
               ) %>% 
  
# Giving the columns pretty labels  
  
  cols_label(name = "Country",
             emissions_control = "Emissions Under Control",
             emissions_treatment = "Emissions Under Treatment") %>% 
  
# Center-aligning the values in each column  
  
  cols_align(align = "center",
             columns = vars(emissions_control,
                            emissions_treatment))

```