---
title: "Exam 1"
author: "Westley Cook"
date: "2/22/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(janitor)
library(gt)

```

```{r read-paris-data, include=FALSE}

paris <- read_csv("raw-data/paris.csv") %>% 
  clean_names()

```

### Question 1

```{r question1.1, echo=FALSE}

country <- paris %>% 
  arrange(desc(emissions)) %>% 
  slice(1) %>% 
  pull(name)

```

1. The highest emissions are from the country **`r country`**.

```{r question1.2, echo=FALSE}

number_countries <- paris %>% 
  filter(kind != "Ratification") %>% 
  filter(kind != "Approval") %>% 
  count() %>% 
  pull(n)

```

2. The number of countries that have neither ratified nor approved of the treaty
is **`r number_countries`**.
*This number includes only countries who indicated acceptance or accession.*

```{r question1.3, echo=FALSE}

longest_days <- paris %>% 
  filter(kind == "Ratification") %>% 
  mutate(gap = ratification - signature) %>% 
  arrange(desc(gap)) %>% 
  slice(1) %>% 
  pull(gap)
  
```

3. The longest number of days between signature and ratification (for a country
that has successfully ratified) is **`r longest_days`** days.

```{r question1.4, echo=FALSE}

number_stan <- paris %>% 
  filter(str_detect(name, "stan"),
         kind == "Ratification") %>% 
  count() %>% 
  pull(n)

```

4. The number of ratifying countries whose name ends with “stan” is 
**`r number_stan`**.

```{r read-co2-data, include=FALSE}

emissions <- read_csv("raw-data/WB_co2_emisions.csv", 
                      skip = 4,
                      col_types = cols()) %>% 
  clean_names()

```

```{r question1.5, echo=FALSE}

highest_1960 <- emissions %>% 
  arrange(desc(x1960)) %>% 
  slice(1) %>% 
  pull(country_name)

```

5. In 1960, the country with the highest emissions was **`r highest_1960`**.

```{r question1.6, echo=FALSE}

avg2000 <- emissions %>% 
  summarize(avg_2000 = mean(x2000, na.rm = TRUE)) %>% 
  pull(avg_2000) %>% 
  round(digits = 2)

```
  
6. The average emissions in 2000 was **`r avg2000`** metric tons per capita.

<br>

### Question 2

```{r question2, echo=FALSE}

emissions_tidy <- emissions %>% 
pivot_longer(cols = c(x1960:x2019),
             names_to = "year",
             values_to = "emissions_per_captita",
             names_prefix = "x") %>% 
  type_convert(col_types = cols())
  

joined <- emissions_tidy %>% 
  left_join(paris,
             by = c("year", 
                    "country_code" = "code"))

# x %>% 
#   filter(year == "1960") %>% 
#   arrange(emissions_per_captita)
# 
# x %>% 
#   filter(year == "1960") %>% 
#   arrange(desc(emissions_per_captita))

date <- joined %>%
  filter(date_of_effect == "2016-11-04") %>%
  slice(1) %>%
  pull(date_of_effect)

joined %>% 
  filter(country_name == "United States" |
           country_name == "Canada" |
           country_name == "Mexico",
         emissions_per_captita != "NA") %>% 
  ggplot(aes(x = year,
             y = emissions_per_captita,
             color = country_name,
             group = country_name)) +
  geom_point() +
  geom_line() +
  geom_vline(xintercept = as.numeric(format(date, "%Y")),
             linetype = "dotted") +
  labs(title = "   CO2 Emissions of North American Countries, 1960 - 2014",
       y = "Metric Tons Per Capita",
       x = "Year") +
  scale_color_discrete(name = "Country",
                       breaks = c("United States",
                                  "Canada",
                                  "Mexico")) +
  scale_x_continuous(breaks = seq(1960,
                                  2020,
                                  by = 10),
                     labels = c("1960",
                                "1970",
                                "1980",
                                "1990",
                                "2000",
                                "2010",
                                "2020")
                     ) +
  theme_classic() +
  annotate("text",
           x = 2016, 
           y = 9.5, 
           label = "Year Paris Accord\nTook Effect (2016)",
           color = "gray28",
           size =3.5,
           angle = 90)

```

<br>

### Question 3

#### Potential Outcomes under the Rubin Causal Framework

The table below shows potential outcomes under the Rubin Causal Framework for
countries which ratified the Paris Accord. Suppose we had run an experiment in
which we assigned a treatment to all countries whose name begins with a vowel:
we gave each of them $1 billion to fight climate change.

(Assigning treatment to countries whose name begins with a
vowel may not be a very good random assignment mechanism and may even compromise
the results of our experiment, since there are far more countries whose names
begin with consonants and ideally we’d have ~50% of countries receiving
treatment and the remaining ~50% in the control group; nevertheless, suppose we
used it.)

The causal effect we are trying to measure is the difference in emissions for a
given country when it receives $1 billion compared to the same country when it
does *not* receive $1 billion. Measuring this causal effect is difficult,
because we only know one value per country: as you see in the table (in which
unknown values are marked by “?”) emissions for a “treated” country are unknown
in the “Control” column and vice versa. However, by making assumptions to “fill
in” the unknown values, we can approximate the causal effect.

<br>

```{r question3, echo=FALSE}

paris_experiment <- paris %>% 
  filter(kind == "Ratification") %>% 
  select(name, emissions) %>% 
  mutate(emissions_treatment = emissions) %>% 
  rename(emissions_control = emissions) %>% 
  mutate(emissions_treatment = ifelse(startsWith(name, "A") |
                                        startsWith(name, "E") |
                                        startsWith(name, "I") |
                                        startsWith(name, "O") |
                                        startsWith(name, "U"),
                                      emissions_treatment,
                                      "?")) %>% 
  mutate(emissions_control = ifelse(startsWith(name, "A") |
                                        startsWith(name, "E") |
                                        startsWith(name, "I") |
                                        startsWith(name, "O") |
                                        startsWith(name, "U"),
                                      "?",
                                      emissions_control))


paris_experiment %>%
  filter(name == "Afghanistan" |
           name == "Bahamas" |
           name == "Cabo Verde" |
           name == "Democratic People's Repulbic of Korea" |
           name == "Ecuador" |
           name == "Finland" |
           name == "Gabon" |
           name == "Haiti" |
           name == "India" |
           name == "Jamaica" |
           name == "Kazakhstan" |
           name == "Lao People's Democratic Republic" |
           name == "Madagascar" |
           name == "Namibia" |
           name == "Oman" |
           name == "Pakistan" |
           name == "Qatar" |
           name == "Republic of Korea" |
           name == "Samoa" |
           name == "Tajikistan" |
           name == "Uganda" |
           name == "Vanuatu" |
           name == "Zambia") %>% 
  gt() %>% 
  tab_header(title = "Potential Outcomes for Paris Experiment on Emissions and 
             Climate Change",
             subtitle = "For Selected Countries") %>% 
  
# Adding spanner label for columns eval_under_control and eval_under_treatment  
  
  tab_spanner(label = "Potential Outcomes",
              columns = vars(emissions_control,
                             emissions_treatment)
              ) %>% 
  
# Adding footnote as shown in the table I'm replicating; had to specify "title"
# within cells_title() to get a warning message to disappear.
  
  tab_footnote(footnote = "Treatment is receiving $1 billion to fight climate 
               change, and was given to all countries whose names begin with 
               vowels",
               locations = cells_column_labels()
               ) %>% 
  
  tab_footnote(footnote = "Only one country is shown for each letter of the 
               alphabet",
               locations = cells_title("subtitle")
               ) %>% 
  
# Giving the columns pretty labels  
  
  cols_label(name = "Country",
             emissions_control = "Emissions Under Control",
             emissions_treatment = "Emissions Under Treatment") %>% 
  
# Center-aligning the values in each column  
  
  cols_align(align = "center",
             columns = vars(emissions_control,
                            emissions_treatment))

```